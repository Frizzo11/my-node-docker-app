name: CI/CD - Build, Test and Deploy Node.js App to VM

on:
  push:
    branches:
      - master  # o "master", seg√∫n tu repositorio

jobs:
  build-test-deploy:
    name: Build ‚Üí Test ‚Üí Deploy
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Clonar el repositorio
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Instalar Node.js
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18  # o la versi√≥n que uses

      # 3Ô∏è‚É£ Instalar dependencias
      - name: Install dependencies
        run: npm ci

      # 4Ô∏è‚É£ Ejecutar tests antes del build
      - name: Run tests
        run: npm test

      # 5Ô∏è‚É£ Loguearse en Docker Hub
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      # 6Ô∏è‚É£ Construir imagen Docker
      - name: Build Docker image
        run: docker build -t ${{ secrets.DOCKER_USERNAME }}/my-node-app:latest .

      # 7Ô∏è‚É£ Subir imagen a Docker Hub
      - name: Push image to Docker Hub
        run: docker push ${{ secrets.DOCKER_USERNAME }}/my-node-app:latest

      # 8Ô∏è‚É£ Desplegar la app en la VM
      - name: Deploy to VM
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.VM_KEY }}
          script: |
            echo "üîÑ Updating container on VM..."
            sudo docker pull ${{ secrets.DOCKER_USERNAME }}/my-node-app:latest
            sudo docker stop my-node-app || true
            sudo docker rm my-node-app || true
            sudo docker run -d \
              --restart=always \
              -p 8080:8080 \
              --name my-node-app \
              ${{ secrets.DOCKER_USERNAME }}/my-node-app:latest

      # 9Ô∏è‚É£ Verificar que est√© corriendo
      - name: Verify container status
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.VM_KEY }}
          script: |
            echo "‚úÖ Checking running containers..."
            sudo docker ps | grep my-node-app
